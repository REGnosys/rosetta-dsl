name: License Scanning for Maven

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'pom.xml'
      - '.github/workflows/license-scanning.yml'
  pull_request:
    paths:
      - 'pom.xml'
      - '.github/workflows/license-scanning.yml'

# Cancel previous jobs
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  ALLOW_LICENSES: "
    licenses/license/name!='Apache License, Version 2.0' and
    licenses/license/name!='The Apache License, Version 2.0' and
    licenses/license/name!='The Apache Software License, Version 2.0' and
    licenses/license/name!='Apache Software Licenses' and
    licenses/license/name!='Apache-2.0' and
    licenses/license/name!='Apache 2.0' and
    
    licenses/license/name!='BSD License' and
    licenses/license/name!='BSD license' and
    licenses/license/name!='BSD licence' and
    
    licenses/license/name!='New BSD License' and
    
    licenses/license/name!='BSD-3-Clause' and
    
    licenses/license/name!='Eclipse Public License - v 1.0' and
    licenses/license/name!='Eclipse Public License, Version 1.0' and
    licenses/license/name!='Eclipse Public License 1.0' and
    licenses/license/name!='Eclipse Public License' and
    
    licenses/license/name!='Eclipse Public License - v 2.0' and
    licenses/license/name!='Eclipse Public License, Version 2.0' and
    licenses/license/name!='The Eclipse Public License Version 2.0' and
    licenses/license/name!='Eclipse Public License 2.0' and
    licenses/license/name!='Eclipse Public License v2.0' and
    
    licenses/license/name!='GNU Lesser General Public License' and
    
    licenses/license/name!='GNU General Public License (GPL), version 2, with the Classpath exception' and
    
    licenses/license/name!='MIT License' and
    licenses/license/name!='MIT license' and
    licenses/license/name!='MIT' and
    licenses/license/name!='The MIT License' and
    licenses/license/name!='The MIT License (MIT)' and
    
    licenses/license/name!='CDDL + GPLv2 with classpath exception' and
    
    licenses/license/name!='Public Domain'
    "
  REPORT_PATH: "target/generated-resources"

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install XQ
      run: pip install xq
    - uses: ./.github/actions/maven-build
      with:
        build-command: install
        run-tests: false
    - name: License XML report
      run: mvn org.codehaus.mojo:license-maven-plugin:2.4.0:aggregate-download-licenses
    - name: Validate XML report
      run: |
        LICENSE_REPORT=`xq "//dependency[${{ env.ALLOW_LICENSES }}]" ./${{ env.REPORT_PATH }}/licenses.xml`
        LINES_FOUND=`echo "$LICENSE_REPORT" | wc -l`
        if [ $LINES_FOUND -gt 1 ]; then echo "License issues found ..." ; echo "$LICENSE_REPORT" ; exit -1; fi
    - name: Upload license reports
      uses: actions/upload-artifact@v4
      with:
        name: license-reports
        path: '**/${{ env.REPORT_PATH }}/'
    - name: Upload license XML reports
      uses: actions/upload-artifact@v4
      with:
        name: license-xml-reports
        path: '**/${{ env.REPORT_PATH }}/licenses.xml'
